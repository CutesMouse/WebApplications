<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>單字學習 (40天搞定新日檢N3單字)</title>
    <style>
        body {
            display: block;
            font-family: "微軟正黑體", serif;
        }

        #questions div:nth-child(2n) {
            background-color: #f3f3f3;
        }

        span {
            padding: 5px 0;
            margin: 5px 0;
        }

        #questions div {
            padding: 20px 30px;
            font-size: 20px;
        }

        .voc, .voc_chinese, .translate {
            border-radius: 30px;
            padding: 5px 10px;
            margin: 0 10px;
            border: solid #8e8e8e 1px;
        }

        .translate {
            color: #236800;
            background-color: #f5ffe5;
        }

        .voc_chinese {
            color: #705d00;
            background-color: #fff7e5;
        }

        .voc {
            color: #9e0000;
            background-color: #ffdbdb;
        }

        .answer {
            padding: 5px;
            margin: 0 10px;
            font-size: 20px;
        }

        .control {
            display: block;
            text-align: center;
        }

        .response_answer {
            color: red;
        }


    </style>
    <script src="voc.js"></script>
    <script>
        // AUTO LOAD
        document.addEventListener('DOMContentLoaded', () => {
            for (let option of document.getElementById('level').children) {
                let value = option.value;
                let level = 0;
                if (value[0] === 'M') { // 綜合
                    level = parseInt(value.substring(1).split('-')[0]);
                } else level = parseInt(option.value);
                if (get_questions(level) !== "") option.disabled = false;
                else option.disabled = true;
            }
        });

        function convert_json(source) {
            let ary = source.split("\n");
            let result = [];
            for (const line of ary) {
                let content = line.split("/");
                result.push({
                    "sentense": content[0],
                    "voc": content[1],
                    "voc_chinese": content[2],
                    "translate": content[3],
                    "blank": content[0].split('{')[1].split('}')[0]
                });
            }
            return result;
        }

        function start_generate() {
            let div = document.getElementById('questions');
            let val = document.getElementById('level').value;
            let mixed = val[0] === 'M';
            let from = parseInt(mixed ? val.substring(1).split('-')[0] : val);
            let to = parseInt(mixed ? val.substring(1).split('-')[1] : val);
            generate_questions(from, to, (mixed ? 20 : 24), div);
        }

        function generate_questions(from_level, to_level, number, div) {
            let problem_list = [];
            for (let i = from_level; i <= to_level; i++) {
                let source = get_questions(i);
                if (source === "") continue;
                problem_list = problem_list.concat(convert_json(source));
            }

            problem_list = randomize(problem_list);

            div.innerHTML = "";

            let last_answer = null;
            for (let i = 0; i < number; i++) {
                let problem = problem_list[i];
                let box = document.createElement("div");
                let part1 = document.createElement('span');
                let part2 = document.createElement('span');
                let answer = document.createElement('input');
                answer.type = "text";
                answer.attempt = 0;
                answer.classList.add('answer');
                answer.onkeyup = function (event) {
                    if (event.key !== "Enter") return;
                    submit(box, part1, answer, part2, problem);
                }
                part1.innerHTML = problem.sentense.split("{")[0];
                part2.innerHTML = problem.sentense.split("}")[1];
                box.appendChild(part1);
                box.appendChild(answer);
                box.appendChild(part2);
                div.appendChild(box);
                if (last_answer != null) {
                    last_answer.to_next = function () {
                        answer.focus();
                    }
                }
                last_answer = answer;
            }
        }

        function shuffle(items) {
            var cached = items.slice(0), temp, i = cached.length, rand;
            while (--i) {
                rand = Math.floor(i * Math.random());
                temp = cached[rand];
                cached[rand] = cached[i];
                cached[i] = temp;
            }
            return cached;
        }

        function randomize(problems) {
            let new_picked = [];
            for (let i = 0; i < problems.length; i += 2) {
                new_picked.push(problems[i + (Math.random() > 0.5)])
            }
            return shuffle(new_picked);
        }

        function add_hint(box, answer, problem) {
            let hint = document.createElement('span');
            if (answer.attempt === 0) {
                hint.classList.add("translate");
                hint.innerHTML = problem.translate;
                box.appendChild(hint);
                answer.attempt = 1;
            } else if (answer.attempt === 1) {
                hint.classList.add("voc_chinese");
                hint.innerHTML = problem.voc_chinese;
                box.appendChild(hint);
                answer.attempt = 2;
            } else if (answer.attempt === 2) {
                hint.classList.add("voc");
                hint.innerHTML = problem.voc;
                box.appendChild(hint);
                answer.attempt = 3;
            }
        }

        function isCorrect(answer_value, problem) {
            if (answer_value === problem.blank) return true;
            if (problem.voc.indexOf('(') !== -1) {
                let kata = problem.voc.split('(')[1].split(')')[0];
                let kanji = problem.voc.split('(')[0];
                if (answer_value === kata || answer_value === kanji) return true;
            } else if (answer_value === problem.voc) return true;
            return false;
        }

        function submit(box, part1, answer, part2, problem) {
            if (isCorrect(answer.value, problem)) {
                let correct = document.createElement('span');
                let r1 = document.createElement('span');
                let ra = document.createElement('span');
                let r2 = document.createElement('span');
                r1.classList.add('response');
                r2.classList.add('response');
                ra.classList.add('response_answer');
                correct.appendChild(r1);
                correct.appendChild(ra);
                correct.appendChild(r2);
                r1.innerHTML = part1.innerHTML;
                ra.innerHTML = problem.blank;
                r2.innerHTML = part2.innerHTML;
                answer.attempt = 0;
                box.innerHTML = "";
                box.appendChild(correct);
                for (let i = 0; i < 3; i++) add_hint(box, answer, problem);
                if (answer.to_next != null) answer.to_next();
            } else {
                add_hint(box, answer, problem);
            }
        }
    </script>
</head>
<body>
<div class="control">
    <select id="level">
        <option value="M1-40">綜合 (全章節/20題)</option>
        <option value="M1-9">綜合 (名詞/20題)</option>
        <option value="M10-12">綜合 (い形容詞/20題)</option>
        <option value="M13-15">綜合 (な形容詞/20題)</option>
        <option value="M16-33">綜合 (動詞/20題)</option>
        <option value="M34-37">綜合 (副詞/20題)</option>
        <option value="M38-40">綜合 (外來語/20題)</option>
        <option value="0">- 名詞 -</option>
        <option value="1">1 (名詞/24題)</option>
        <option value="2">2 (名詞/24題)</option>
        <option value="3">3 (名詞/24題)</option>
        <option value="4">4 (名詞/24題)</option>
        <option value="5">5 (名詞/24題)</option>
        <option value="6">6 (名詞/24題)</option>
        <option value="7">7 (名詞/24題)</option>
        <option value="8">8 (名詞/24題)</option>
        <option value="9">9 (名詞/24題)</option>
        <option value="0">- い形容詞 -</option>
        <option value="10">10 (い形容詞/24題)</option>
        <option value="11">11 (い形容詞/24題)</option>
        <option value="12">12 (い形容詞/24題)</option>
        <option value="0">- な形容詞 -</option>
        <option value="13">13 (な形容詞/24題)</option>
        <option value="14">14 (な形容詞/24題)</option>
        <option value="15">15 (な形容詞/24題)</option>
        <option value="0">- 動詞 -</option>
        <option value="16">16 (動詞/24題)</option>
        <option value="17">17 (動詞/24題)</option>
        <option value="18">18 (動詞/24題)</option>
        <option value="19">19 (動詞/24題)</option>
        <option value="20">20 (動詞/24題)</option>
        <option value="21">21 (動詞/24題)</option>
        <option value="22">22 (動詞/24題)</option>
        <option value="23">23 (動詞/24題)</option>
        <option value="24">24 (動詞/24題)</option>
        <option value="25">25 (動詞/24題)</option>
        <option value="26">26 (動詞/24題)</option>
        <option value="27">27 (動詞/24題)</option>
        <option value="28">28 (動詞/24題)</option>
        <option value="29">29 (動詞/24題)</option>
        <option value="30">30 (動詞/24題)</option>
        <option value="31">31 (動詞/24題)</option>
        <option value="32">32 (動詞/24題)</option>
        <option value="33">33 (動詞/24題)</option>
        <option value="0">- 副詞 -</option>
        <option value="34">34 (副詞/24題)</option>
        <option value="35">35 (副詞/24題)</option>
        <option value="36">36 (副詞/24題)</option>
        <option value="37">37 (副詞/24題)</option>
        <option value="0">- 外來語 -</option>
        <option value="38">38 (外來語/24題)</option>
        <option value="39">39 (外來語/24題)</option>
        <option value="40">40 (外來語/24題)</option>

    </select>
    <input type="button" value="生成題目" onclick="start_generate()">
</div>
<div id="questions">
</div>
</body>
</html>
